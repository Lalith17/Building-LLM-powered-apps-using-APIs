{% extends 'base.html' %}
{% block title %}Session Summary - VMIS{% endblock %}
{% block content %}
<h1>Interview Session Summarizer</h1>
<p>Transform your raw interview notes into a concise, professional summary.</p>

{% if error %}
<div class="alert alert-error">
    <strong>Error:</strong> {{ error }}
</div>
{% endif %}

{% if success %}
<div class="alert alert-success">
    <strong>Success:</strong> Summary generated successfully!
</div>
{% endif %}

<form id="summaryForm" method="POST" action="/llm/summarize_session">
    <div class="form-group">
        <label for="interview_notes">Interview Session Notes:</label>
        <textarea id="interview_notes" name="interview_notes" 
                  placeholder="Enter detailed notes from the interview session. Include questions asked, candidate responses, observations about their performance, strengths, weaknesses, and any other relevant details from the session." 
                  required>{{ request.form.interview_notes if request.form else '' }}</textarea>
        <small class="help-text">Provide comprehensive session notes (20-3000 characters)</small>
        <div class="char-counter">
            <span id="charCount">0</span> / 3000 characters
        </div>
    </div>
    
    <button type="submit" class="btn btn-primary" id="generateBtn">
        <span class="btn-text">Generate Summary</span>
        <span class="loading-spinner" style="display: none;">‚ü≥ Generating...</span>
    </button>
</form>

{% if summary %}
<div class="results-section">
    <h2>Session Summary</h2>
    <div class="summary-header">
        <span><strong>Generated on:</strong> {{ moment().format('YYYY-MM-DD HH:mm') if moment else 'Today' }}</span>
        <span><strong>Word count:</strong> <span id="wordCount">-</span> words</span>
    </div>
    
    <div class="summary-content">
        {{ summary|replace('\n', '<br>')|safe }}
    </div>
    
    <div class="action-buttons">
        <button onclick="copySummary()" class="btn btn-secondary">Copy Summary</button>
        <button onclick="printSummary()" class="btn btn-secondary">Print Summary</button>
        <button onclick="emailSummary()" class="btn btn-secondary">Email Summary</button>
    </div>
</div>
{% endif %}

<script>
// Character counter and word counter
const textarea = document.getElementById('interview_notes');
const charCount = document.getElementById('charCount');

function updateCharCount() {
    const count = textarea.value.length;
    charCount.textContent = count;
    
    if (count > 3000) {
        charCount.style.color = '#dc3545';
    } else if (count > 2700) {
        charCount.style.color = '#fd7e14';
    } else {
        charCount.style.color = '#28a745';
    }
}

function updateWordCount() {
    const summaryElement = document.querySelector('.summary-content');
    if (summaryElement) {
        const text = summaryElement.innerText || summaryElement.textContent;
        const wordCount = text.trim().split(/\s+/).length;
        document.getElementById('wordCount').textContent = wordCount;
    }
}

textarea.addEventListener('input', updateCharCount);
updateCharCount(); // Initial count
updateWordCount(); // Initial word count

// Form submission handling
document.getElementById('summaryForm').addEventListener('submit', function(e) {
    const btn = document.getElementById('generateBtn');
    const btnText = btn.querySelector('.btn-text');
    const loadingSpinner = btn.querySelector('.loading-spinner');
    
    // Validate input
    const notes = textarea.value.trim();
    if (notes.length < 20) {
        e.preventDefault();
        alert('Interview notes must be at least 20 characters long.');
        return;
    }
    if (notes.length > 3000) {
        e.preventDefault();
        alert('Interview notes must be less than 3000 characters.');
        return;
    }
    
    btnText.style.display = 'none';
    loadingSpinner.style.display = 'inline';
    btn.disabled = true;
});

function copySummary() {
    const summaryElement = document.querySelector('.summary-content');
    const text = summaryElement.innerText || summaryElement.textContent;
    
    navigator.clipboard.writeText(text).then(() => {
        alert('Summary copied to clipboard!');
    }).catch(err => {
        console.error('Failed to copy: ', err);
        // Fallback for older browsers
        const textArea = document.createElement('textarea');
        textArea.value = text;
        document.body.appendChild(textArea);
        textArea.select();
        document.execCommand('copy');
        document.body.removeChild(textArea);
        alert('Summary copied to clipboard!');
    });
}

function printSummary() {
    const summaryContent = document.querySelector('.summary-content').innerHTML;
    const today = new Date().toLocaleDateString();
    const printWindow = window.open('', '_blank');
    printWindow.document.write(`
        <html>
            <head>
                <title>Interview Session Summary</title>
                <style>
                    body { font-family: Arial, sans-serif; line-height: 1.6; margin: 20px; }
                    h1 { color: #333; border-bottom: 2px solid #007bff; padding-bottom: 10px; }
                    .header { margin-bottom: 20px; color: #666; }
                    .summary { margin-top: 20px; }
                    @media print {
                        body { margin: 0; }
                        .no-print { display: none; }
                    }
                </style>
            </head>
            <body>
                <h1>Interview Session Summary</h1>
                <div class="header">
                    <p><strong>Generated on:</strong> ${today}</p>
                    <p><strong>System:</strong> Visa Mock Interview System (VMIS)</p>
                </div>
                <div class="summary">${summaryContent}</div>
            </body>
        </html>
    `);
    printWindow.document.close();
    printWindow.print();
}

function emailSummary() {
    const summaryElement = document.querySelector('.summary-content');
    const text = summaryElement.innerText || summaryElement.textContent;
    const subject = encodeURIComponent('Interview Session Summary - VMIS');
    const body = encodeURIComponent(`Interview Session Summary\n\nGenerated on: ${new Date().toLocaleDateString()}\n\n${text}\n\n---\nGenerated by Visa Mock Interview System (VMIS)`);
    
    window.location.href = `mailto:?subject=${subject}&body=${body}`;
}
</script>

<style>
.form-group {
    margin-bottom: 20px;
}

.form-group label {
    display: block;
    font-weight: bold;
    margin-bottom: 5px;
    color: #333;
}

.form-group textarea {
    width: 100%;
    min-height: 200px;
    padding: 10px;
    border: 1px solid #ddd;
    border-radius: 4px;
    font-size: 16px;
    font-family: Arial, sans-serif;
    resize: vertical;
}

.help-text {
    display: block;
    color: #666;
    font-size: 14px;
    margin-top: 5px;
}

.char-counter {
    text-align: right;
    font-size: 14px;
    margin-top: 5px;
}

.alert {
    padding: 15px;
    margin-bottom: 20px;
    border-radius: 4px;
}

.alert-error {
    background-color: #f8d7da;
    color: #721c24;
    border: 1px solid #f5c6cb;
}

.alert-success {
    background-color: #d4edda;
    color: #155724;
    border: 1px solid #c3e6cb;
}

.btn {
    padding: 12px 24px;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    font-weight: bold;
    text-decoration: none;
    display: inline-block;
    transition: background-color 0.3s;
    margin-right: 10px;
    margin-bottom: 10px;
}

.btn-primary {
    background-color: #007bff;
    color: white;
}

.btn-primary:hover:not(:disabled) {
    background-color: #0056b3;
}

.btn-primary:disabled {
    background-color: #6c757d;
    cursor: not-allowed;
}

.btn-secondary {
    background-color: #6c757d;
    color: white;
}

.btn-secondary:hover {
    background-color: #545b62;
}

.results-section {
    margin-top: 40px;
    padding: 20px;
    background-color: #f8f9fa;
    border-radius: 8px;
}

.summary-header {
    display: flex;
    gap: 20px;
    margin-bottom: 20px;
    flex-wrap: wrap;
}

.summary-header span {
    background-color: white;
    padding: 5px 10px;
    border-radius: 4px;
    border: 1px solid #ddd;
    font-size: 14px;
}

.summary-content {
    background-color: white;
    padding: 20px;
    border-radius: 4px;
    border-left: 4px solid #17a2b8;
    margin-bottom: 20px;
    line-height: 1.6;
    white-space: pre-wrap;
}

.action-buttons {
    text-align: center;
}

.loading-spinner {
    animation: spin 1s linear infinite;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

@media (max-width: 768px) {
    .action-buttons {
        text-align: left;
    }
    
    .btn {
        display: block;
        width: 100%;
        margin-right: 0;
        text-align: center;
    }
    
    .summary-header {
        flex-direction: column;
        gap: 10px;
    }
}
</style>
{% endblock %}
