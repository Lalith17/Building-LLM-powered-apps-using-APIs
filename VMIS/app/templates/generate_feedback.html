{% extends 'base.html' %}
{% block title %}Feedback Generator - VMIS{% endblock %}
{% block content %}
<h1>AI Feedback Generator</h1>
<p>Get constructive feedback based on your interview performance notes.</p>

{% if error %}
<div class="alert alert-error">
    <strong>Error:</strong> {{ error }}
</div>
{% endif %}

{% if success %}
<div class="alert alert-success">
    <strong>Success:</strong> Feedback generated successfully!
</div>
{% endif %}

<form id="feedbackForm" method="POST" action="/llm/generate_feedback">
    <div class="form-group">
        <label for="performance_notes">Performance Notes:</label>
        <textarea id="performance_notes" name="performance_notes" 
                  placeholder="Enter detailed notes about the candidate's performance during the interview. Include observations about their communication skills, confidence level, answers quality, body language, etc." 
                  required>{{ request.form.performance_notes if request.form else '' }}</textarea>
        <small class="help-text">Provide detailed performance observations (10-2000 characters)</small>
        <div class="char-counter">
            <span id="charCount">0</span> / 2000 characters
        </div>
    </div>
    
    <button type="submit" class="btn btn-primary" id="generateBtn">
        <span class="btn-text">Generate Feedback</span>
        <span class="loading-spinner" style="display: none;">‚ü≥ Generating...</span>
    </button>
</form>

{% if feedback %}
<div class="results-section">
    <h2>Generated Feedback</h2>
    <div class="feedback-content">
        {{ feedback|replace('\n', '<br>')|safe }}
    </div>
    
    <div class="action-buttons">
        <button onclick="copyFeedback()" class="btn btn-secondary">Copy Feedback</button>
        <button onclick="printFeedback()" class="btn btn-secondary">Print Feedback</button>
    </div>
</div>
{% endif %}

<script>
// Character counter
const textarea = document.getElementById('performance_notes');
const charCount = document.getElementById('charCount');

function updateCharCount() {
    const count = textarea.value.length;
    charCount.textContent = count;
    
    if (count > 2000) {
        charCount.style.color = '#dc3545';
    } else if (count > 1800) {
        charCount.style.color = '#fd7e14';
    } else {
        charCount.style.color = '#28a745';
    }
}

textarea.addEventListener('input', updateCharCount);
updateCharCount(); // Initial count

// Form submission handling
document.getElementById('feedbackForm').addEventListener('submit', function(e) {
    const btn = document.getElementById('generateBtn');
    const btnText = btn.querySelector('.btn-text');
    const loadingSpinner = btn.querySelector('.loading-spinner');
    
    // Validate input
    const notes = textarea.value.trim();
    if (notes.length < 10) {
        e.preventDefault();
        alert('Performance notes must be at least 10 characters long.');
        return;
    }
    if (notes.length > 2000) {
        e.preventDefault();
        alert('Performance notes must be less than 2000 characters.');
        return;
    }
    
    btnText.style.display = 'none';
    loadingSpinner.style.display = 'inline';
    btn.disabled = true;
});

function copyFeedback() {
    const feedbackElement = document.querySelector('.feedback-content');
    const text = feedbackElement.innerText || feedbackElement.textContent;
    
    navigator.clipboard.writeText(text).then(() => {
        alert('Feedback copied to clipboard!');
    }).catch(err => {
        console.error('Failed to copy: ', err);
        // Fallback for older browsers
        const textArea = document.createElement('textarea');
        textArea.value = text;
        document.body.appendChild(textArea);
        textArea.select();
        document.execCommand('copy');
        document.body.removeChild(textArea);
        alert('Feedback copied to clipboard!');
    });
}

function printFeedback() {
    const feedbackContent = document.querySelector('.feedback-content').innerHTML;
    const printWindow = window.open('', '_blank');
    printWindow.document.write(`
        <html>
            <head>
                <title>Interview Feedback</title>
                <style>
                    body { font-family: Arial, sans-serif; line-height: 1.6; margin: 20px; }
                    h1 { color: #333; }
                    .feedback { margin-top: 20px; }
                </style>
            </head>
            <body>
                <h1>Interview Feedback Report</h1>
                <p><strong>Generated on:</strong> ${new Date().toLocaleDateString()}</p>
                <div class="feedback">${feedbackContent}</div>
            </body>
        </html>
    `);
    printWindow.document.close();
    printWindow.print();
}
</script>

<style>
.form-group {
    margin-bottom: 20px;
}

.form-group label {
    display: block;
    font-weight: bold;
    margin-bottom: 5px;
    color: #333;
}

.form-group textarea {
    width: 100%;
    min-height: 150px;
    padding: 10px;
    border: 1px solid #ddd;
    border-radius: 4px;
    font-size: 16px;
    font-family: Arial, sans-serif;
    resize: vertical;
}

.help-text {
    display: block;
    color: #666;
    font-size: 14px;
    margin-top: 5px;
}

.char-counter {
    text-align: right;
    font-size: 14px;
    margin-top: 5px;
}

.alert {
    padding: 15px;
    margin-bottom: 20px;
    border-radius: 4px;
}

.alert-error {
    background-color: #f8d7da;
    color: #721c24;
    border: 1px solid #f5c6cb;
}

.alert-success {
    background-color: #d4edda;
    color: #155724;
    border: 1px solid #c3e6cb;
}

.btn {
    padding: 12px 24px;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    font-weight: bold;
    text-decoration: none;
    display: inline-block;
    transition: background-color 0.3s;
    margin-right: 10px;
}

.btn-primary {
    background-color: #007bff;
    color: white;
}

.btn-primary:hover:not(:disabled) {
    background-color: #0056b3;
}

.btn-primary:disabled {
    background-color: #6c757d;
    cursor: not-allowed;
}

.btn-secondary {
    background-color: #6c757d;
    color: white;
}

.btn-secondary:hover {
    background-color: #545b62;
}

.results-section {
    margin-top: 40px;
    padding: 20px;
    background-color: #f8f9fa;
    border-radius: 8px;
}

.feedback-content {
    background-color: white;
    padding: 20px;
    border-radius: 4px;
    border-left: 4px solid #28a745;
    margin-bottom: 20px;
    line-height: 1.6;
    white-space: pre-wrap;
}

.action-buttons {
    text-align: center;
}

.loading-spinner {
    animation: spin 1s linear infinite;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}
</style>
{% endblock %}
